# Lefthook Git hooks é…ç½®æ–‡ä»¶
# æ–‡æ¡£: https://github.com/evilmartians/lefthook

# Pre-commit hooks - åœ¨æäº¤å‰è¿è¡Œ
pre-commit:
  parallel: true
  commands:
    # ä½¿ç”¨ Makefile çš„ format-staged å‘½ä»¤æ ¼å¼åŒ–æš‚å­˜çš„ Go ä»£ç 
    go-fmt:
      run: make format-staged
      stage_fixed: true
      glob: "*.go"

    # ä½¿ç”¨ Makefile çš„ lint-staged å‘½ä»¤æ£€æŸ¥æš‚å­˜çš„ Go ä»£ç 
    # æ³¨æ„ï¼šgolangci-lint å·²ç»åŒ…å«äº† go vet å’Œ revive æ£€æŸ¥ï¼Œæ‰€ä»¥ä¸éœ€è¦å•ç‹¬çš„ go-vet å’Œ go-revive hooks
    go-golangci-lint:
      run: make lint-staged
      glob: "*.go"
      skip:
        - merge
        - rebase

    # æ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•ä»£ç ï¼ˆå¦‚ fmt.Println, debugger ç­‰ï¼‰
    no-debug:
      run: |
        debug_patterns="fmt\\.Print|fmt\\.Printf|fmt\\.Println|debugger|console\\.log"
        debug_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(go|js|ts)$' || true)
        if [ -n "$debug_files" ]; then
          for file in $debug_files; do
            if grep -E "$debug_patterns" "$file" >/dev/null 2>&1; then
              echo "âš ï¸  $file ä¸­å¯èƒ½åŒ…å«è°ƒè¯•ä»£ç ï¼Œè¯·æ£€æŸ¥"
            fi
          done
        fi
      skip:
        - merge
        - rebase

# Commit-msg hooks - æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼
commit-msg:
  commands:
    commit-msg-lint:
      run: |
        # æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼
        # æ ¼å¼: <type>(<scope>): <subject>
        # type: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
        
        # è·å–æäº¤æ¶ˆæ¯æ–‡ä»¶è·¯å¾„ï¼ˆLefthook ä¼šå°†æ–‡ä»¶è·¯å¾„ä½œä¸ºå‚æ•°ä¼ é€’ï¼‰
        if [ -n "$1" ] && [ -f "$1" ]; then
          commit_msg_file="$1"
        else
          # å°è¯•ä»ç¯å¢ƒå˜é‡æˆ–é»˜è®¤ä½ç½®è·å–
          commit_msg_file="${LEFTHOOK_COMMIT_MSG_FILE:-.git/COMMIT_EDITMSG}"
        fi
        
        # è¯»å–æäº¤æ¶ˆæ¯
        if [ -f "$commit_msg_file" ]; then
          commit_msg=$(cat "$commit_msg_file" 2>/dev/null | head -n 1 || echo "")
        else
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ä»æ ‡å‡†è¾“å…¥è¯»å–
          commit_msg=$(cat 2>/dev/null | head -n 1 || echo "")
        fi
        
        # è·³è¿‡ç©ºæ¶ˆæ¯
        if [ -z "$commit_msg" ]; then
          exit 0
        fi
        
        # è·³è¿‡ merge å’Œ revert æäº¤
        if echo "$commit_msg" | grep -qE '^(Merge|Revert)'; then
          exit 0
        fi
        
        # æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼
        if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
          echo "âŒ æäº¤æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®"
          echo ""
          echo "å½“å‰æäº¤æ¶ˆæ¯: $commit_msg"
          echo ""
          echo "æ­£ç¡®æ ¼å¼: <type>(<scope>): <subject>"
          echo ""
          echo "ç±»å‹ (type):"
          echo "  feat:     æ–°åŠŸèƒ½"
          echo "  fix:      ä¿®å¤bug"
          echo "  docs:     æ–‡æ¡£å˜æ›´"
          echo "  style:    ä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œçš„å˜åŠ¨ï¼‰"
          echo "  refactor: é‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°å¢åŠŸèƒ½ï¼Œä¹Ÿä¸æ˜¯ä¿®å¤bugï¼‰"
          echo "  test:     å¢åŠ æµ‹è¯•"
          echo "  chore:    æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨"
          echo "  perf:     æ€§èƒ½ä¼˜åŒ–"
          echo "  ci:       CIé…ç½®æ–‡ä»¶å’Œè„šæœ¬çš„å˜æ›´"
          echo "  build:    æ„å»ºç³»ç»Ÿæˆ–å¤–éƒ¨ä¾èµ–çš„å˜æ›´"
          echo "  revert:   å›æ»š"
          echo ""
          echo "ç¤ºä¾‹:"
          echo "  feat(xjyl): æ·»åŠ è·å–ç¬¬ä¸‰æ–¹ç”¨æˆ·ä¿¡æ¯æ¥å£"
          echo "  fix(login): ä¿®å¤ç™»å½•tokenéªŒè¯é—®é¢˜"
          echo "  docs: æ›´æ–°READMEæ–‡æ¡£"
          exit 1
        fi

# Pre-push hooks - åœ¨æ¨é€å‰è¿è¡Œ
pre-push:
  commands:
    # go-test å·²ç¦ç”¨ï¼ˆæµ‹è¯•éœ€è¦é…ç½®ç¯å¢ƒï¼Œå¯èƒ½å¤±è´¥ï¼‰
    # go-test:
    #   run: |
    #     echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
    #     go test ./... -short
    #   glob: "*.go"
    #   skip:
    #     - merge
    #     - rebase

    # ä½¿ç”¨ Makefile çš„ build å‘½ä»¤æ£€æŸ¥ç¼–è¯‘
    go-build:
      run: make build
      glob: "*.go"

